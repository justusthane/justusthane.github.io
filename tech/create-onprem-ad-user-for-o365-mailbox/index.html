<!DOCTYPE html>
<html style="scroll-behavior: smooth;" lang="en">
<head>
    <meta charset="utf-8" />
    <title>How to create a local AD user for an existing Office365 mailbox | justus.ws</title>

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Home, home on the web, where the links and the hypertexts play">

    <link rel="shortcut icon" type="image/png" href="/images/daoi_round.png" />
    <link rel="canonical" href="https://justus.ws/tech/create-onprem-ad-user-for-o365-mailbox/" />
    <link rel="stylesheet" href="/style/style.css" type="text/css">
    <link rel="stylesheet" href="/style/prism-cb.css" type="text/css">
    <link rel="stylesheet" href="/webfonts/badscript.css" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="/style/fontawesome-all.min.css" type="text/css">
    <link rel="webmention" href="https://webmention.io/justus.ws/webmention" />

</head>
<body id="top" class="color-auto ">
  <div id="toggle-color">
  </div>
  <div id="wrapper">
    <div id="titleContainer">
      <div id="avatar">
        <a href="/"><img alt="Avatar" src="/images/dadi-avatar.png" class="avatar"></a>
      </div>
      <div id="sitetitle">
        <div class="logo"><a href="/" class="u-url u-uid p-name" rel="me">justus<br>grunow</a></div> 
      </div>
    </div>
    <div id="tagline">home, home on the web<br />where the links and the hypertexts play
        <div id="elsewhere">
                      <a href="mailto:jg@justus.ws" rel="me" class="u-email" data-label="<strong>email</strong>&nbsp;| jg@justus.ws" aria-label="Email"><i class="far fa-envelope-open" aria-hidden="true"></i></a>
                                <a href="https://photos.justus.ws" rel="me" data-label="<strong>photos</strong>&nbsp;| smugmug" aria-label="Photography"><i class="fas fa-camera-retro" aria-hidden="true"></i></a>
                                          <a href="https://github.com/justusthane" rel="me" data-label="<strong>code</strong>&nbsp;| github" aria-label="Github"><i class="fab fa-github" aria-hidden="true"></i></a>
                                                  </div>
    </div>
    <div id="sidebar">
      

<details id="menuMobile">
  <summary>Menu</summary>
        <ul>
          <li><a href="/">home</a></li>
          
          <li>
            <a href="/craft/">craft/sewing</a> projects
          </li>
          
          <li>
            <a href="/tech/">tech</a> stuff
          </li>
          
          <li>
            <a href="/food/">food</a> &amp; kitchen
          </li>
          
          <li>
            <a href="/garden/">garden</a>ing
          </li>
          
          <li>
            <a href="/misc/">misc</a>???
          </li>
          
          <li>
            <a href="/writings/">writings</a> &amp; musings
          </li>
          
          <li>
            <a href="/blog/">blog</a>
          </li>
          
          <li>
            <a href="/why/">why</a> does this site exist?
          </li>
          
          <li>
            <a href="/how/">how</a> does this site work?
          </li>
          
          <li>
            <a href="/links/">links</a> &amp; other things I like
          </li>
          
          <li>
            <a href="/now/">now</a>: what I&#39;m up to
          </li>
          
          <li>
            <a href="/todo/">todo</a> for this site
          </li>
          
        </ul>
</details>
        <div id="menuDesktop">
          <ul>
          <li><a href="/">home</a></li>
            
            <li>
              <a href="/craft/">craft/sewing</a> projects
            </li>
            
            <li>
              <a href="/tech/">tech</a> stuff
            </li>
            
            <li>
              <a href="/food/">food</a> &amp; kitchen
            </li>
            
            <li>
              <a href="/garden/">garden</a>ing
            </li>
            
            <li>
              <a href="/misc/">misc</a>???
            </li>
            
            <li>
              <a href="/writings/">writings</a> &amp; musings
            </li>
            
            <li>
              <a href="/blog/">blog</a>
            </li>
            
            <li>
              <a href="/why/">why</a> does this site exist?
            </li>
            
            <li>
              <a href="/how/">how</a> does this site work?
            </li>
            
            <li>
              <a href="/links/">links</a> &amp; other things I like
            </li>
            
            <li>
              <a href="/now/">now</a>: what I&#39;m up to
            </li>
            
            <li>
              <a href="/todo/">todo</a> for this site
            </li>
            
          </ul>
        </div>

    </div>
    </header>

    <main id="content">
      


<a href="/tech"><i class="fas fa-arrow-circle-left"></i>&nbsp;tech</a>
  <h1>

  How to create a local AD user for an existing Office365 mailbox

  </h1>

<p class="publish-date">Published 2021-06-22</p>
<h2 id="the-issue">The Issue</h2>
<p>If you have a hybrid Exchange/O365 environment, and you create an Office365 mailbox without first creating an on-prem Active Directory account, the mailbox will not be able to receive mail from external or on-prem senders (although it will be able to receive mail from other O365 mailboxes!).</p>
<p>This is because all inbound mail goes to the on-prem Exchange server first, and then if the user is on O365 the Exchange server forwards the mail on to O365. If a local AD account doesn’t exist for the O365 mailbox, then the Exchange server has no way of knowing about the O365 mailbox and will reject the message.</p>
<p>Additionally, if you search for the user in the Azure AD portal, you will see that the user is <strong>not</strong> directory synced:<br>
<img src="ss1.png" alt=""></p>
<h2 id="the-resolution">The Resolution</h2>
<ol>
<li>Create an on-prem AD user with the same User Principal Name as the Azure user.</li>
<li>Run the following command in the on-prem Exchange Management Shell to link the new AD user to the existing O365 mailbox:</li>
</ol>
<pre class="language-powershell"><code class="language-powershell"><span class="token comment"># Replace the mailbox name and tenant domain with your own</span><br><span class="token function">Enable-RemoteMailbox</span> <span class="token string">"jim.bob"</span> <span class="token operator">-</span>RemoteRoutingAddress <span class="token string">"jim.bob@contoso.mail.onmicrosoft.com"</span></code></pre>
<ol start="3">
<li><strong>IF</strong> the O365 mailbox is a shared mailbox and not a regular user, also do the following two steps. Otherwise, the O365 mailbox will be converted to a regular mailbox (and will need to be licensed):</li>
<li><code>set-aduser smsace -Replace @{msExchRemoteRecipientType=100;msExchRecipientTypeDetails=34359738368}</code></li>
<li>Disable the local AD account (optional, but typically shared mailboxes are attached to a disabled AD account).</li>
<li>Finally, trigger an AD Connect sync or wait for one to occur. If you search for the user again in Azure AD, it should now say “Directory synced: Yes”:<br>
<img src="ss2.png" alt=""></li>
</ol>
<p>Good to go!</p>

<a href="#wrapper"><i class="fas fa-arrow-circle-up"></i>&nbsp;top</a>

    </main>
    
    
  </div>

  <script src="/js/jquery-3.5.1.min.js"></script>
  <script src="/js/scripts.js"></script>

</body>
</html>
